<!doctype html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/> 
    <meta charset="UTF-8">
    <title> report portlet demo </title>

    <link rel="stylesheet" href="tools/tssJS/css/tss.all.css" type="text/css" />
    <link rel="stylesheet" href="tools/tssJS/css/tss.button.css" type="text/css" />

    <script src="tools/tssJS/tssJS.all.js"></script>
    <script src="tools/tssJS/tssJS.json2Form.js"></script>
    <script src="tools/tssJS/tssJS.jsonp.js"></script>

    <style type="text/css">

        body { background-color: grey;  margin:0;  padding:0; }
 
        iframe {
            width:100%; height:100%; 
        }

        .searchForm {
            background-color:#BEC6EE; border:1px solid #416371; border-radius: 5px;
            width:350px; height:150px; font-size: 12px; padding: 5px; overflow: auto; 
            z-index:999; position:absolute; top:22px; left:1px;
        } 

        .searchForm .buttonBox { margin: 5px 0 5px 80px; }

    </style>


</head>
<body>

    <div id="panel1" style="width:600px;position:absolute;top:0px;left:63px;"></div>
    <div id="panel2" style="width:600px;position:absolute;top:300px;left:40%;"></div>
 
    <script type="text/javascript">
    
        $.leftbar( function() { alert("点击成功") } );
 
initReportPanel($("#panel1"), 62);
initReportPanel($("#panel2"), 63);


var globalValiable = {}; // 用来存放传递给iframe页面的信息   TODO 多个报表一起，数据混乱了，需要加锁。

function initReportPanel($panel, reportId) {
	 $panel.css("height", "400px");

	 $.ajax({
		url: '/tss/data/' +reportId+ '/define',
		method: 'get',
		ondata: function() {
			var define = this.getResponseJSON();
			$panel.title = define[0];
			$panel.url = define[2];
			$panel.define = define[1];

			var _params = $.parseJSON($panel.define);
			var params = {};
			$.each(_params, function(i, param) {
				// TODO 检查是否所有必填的参数都有默认值了，不是的话不宜发起查询
				if(param.defaultValue) {
					var key = "param" + (i+1);
					params[key] = param.defaultValue;
				}
			});

			$panel.panel(define[0] + '【<a href="#" class="setQuery">设置条件</a>】', '<iframe id="chatFrame' +reportId+ '" frameborder="0"></iframe>');
			$panel.find(".setQuery").click(function(){
				getQueryForm(reportId, $panel);
			});

			searchReport(reportId, params, $panel);
		}
	});
}

function getQueryForm(reportId, $panel) {
    var $searchForm = $("#searchForm" + reportId);
    if( !$searchForm.length ) {
        var formId = "searchForm" + reportId;
		var searchFormEl = $.createElement("div", "searchForm", formId);
		$panel.appendChild(searchFormEl);
    }

	createQueryForm(reportId, $panel);
}

function createQueryForm(reportId, $panel) {
	// 先删除已经生成的其它panel的searchForm的form
	$(".searchForm form").remove();
	$(".comboTree").remove();
	$(".searchForm").hide();
	
    var formId = "searchForm" + reportId;
    var searchFormEl = $1(formId);
	$(searchFormEl).show();

    var buttonBox = [];
    buttonBox[buttonBox.length] = "        <TR>";
    buttonBox[buttonBox.length] = "          <TD colspan='2' height='46'><div class='buttonBox'>";
    buttonBox[buttonBox.length] = "             <a class='tssbutton medium black btSearch' >查 询</a> - ";
    buttonBox[buttonBox.length] = "             <a class='tssbutton medium black btClose' >关 闭</a>";
    buttonBox[buttonBox.length] = "          </div></TD>";
    buttonBox[buttonBox.length] = "        </TR>";

    var searchForm = $.json2Form(formId, $panel.define, buttonBox.join(""));

	if($panel.params) { // 设置上一次的查询条件
		setTimeout(function() {
			$.each($panel.params, function(key, value) {
				searchForm.updateDataExternal(key, value);
			});
		
		}, 300); // 待comboTree等加载好
	}

    $.cache.XmlDatas[formId] = searchForm.template.sourceXML;
    
    $(".btSearch", searchFormEl).click( function () {
        if( searchForm.checkForm() ) {
            var searchFormXML = $.cache.XmlDatas[formId];
            var dataNode = searchFormXML.querySelector("data");

            var params = {};
            var nodes = dataNode.querySelectorAll("row *");
            for(var i = 0; i < nodes.length; i++) {
                var node = nodes[i];
                params[node.nodeName] = $.XML.getText(node);
            }

			$panel.params = params; // TODO 记录当前的条件
            searchReport(reportId, params, $panel);

            $(searchFormEl).hide();
        }
    });

    $(".btClose", searchFormEl).click( function () {
        $(searchFormEl).hide(); 
    });
}

function searchReport(reportId, params, $panel) {
    $.ajax({
        url: "/tss/data/json/" + reportId,
        waiting: true,
        params: params,
        ondata: function() {
			//if( !$.isEmptyObject(globalValiable) ) { }
			
			globalValiable.title = $panel.title;
            globalValiable.queryParams = params;
            globalValiable.data = this.getResponseJSON();

            $("#chatFrame" + reportId).show().attr("src", $panel.url);
        }
    })
}


// TODO　定时刷新

    </script>  
</body>
</html>