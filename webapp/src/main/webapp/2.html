<!doctype html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/> 
	<meta charset="UTF-8">
    <title> report portlet demo </title>

    <link rel="stylesheet" href="tools/tssJS/css/tss.all.css" type="text/css" />

    <script src="tools/tssJS/tssJS.all.js"></script>
	<script src="tools/tssJS/tssJS.json2Form.js"></script>
	<script src="tools/tssJS/tssJS.jsonp.js"></script>

    <style type="text/css">

        body { background-color: grey;  margin:0;  padding:0; }
 

    </style>


</head>
<body>

   

    <div id="panel1" style="width:600px;position:absolute;top:0px;left:500px;"></div>
	<div id="panel2" style="width:600px;position:absolute;top:300px;left:200px;"></div>
 
    <script type="text/javascript">
    
        $.leftbar( function() { alert("点击成功") } );

        $("#panel1").css("height", "400px").panel('报表一【<a href="#" onclick="getQueryForm(62)">设置条件</a>】', '<iframe id="chatFrame62" style="width:100%;height:100%;" frameborder="0"></iframe>');

		$("#panel2").css("height", "400px").panel('报表二【<a href="#" onclick="getQueryForm(63)">设置条件</a>】', '<iframe id="chatFrame63" style="width:100%;height:100%;" frameborder="0"></iframe>');


var globalValiable = {}; // 用来存放传递给iframe页面的信息

function getQueryForm(reportId) {
	var $searchForm = $("#searchForm" + reportId);
    if( $searchForm.length ) {
        $searchForm.show();
        return;
    }

	$.ajax({
		url: '/tss/data/param/define/' + reportId,
		method: 'get',
		ondata: function() {
			var define = this.getResponseJSON();
			globalValiable.title = define[0];
			globalValiable.url = define[2];

			createQueryForm(reportId, define[1]);
		}
	});
}

function createQueryForm(reportId, paramConfig) {
	var formId = "searchForm" + reportId;
	var searchFormEl = $.createElement("div", "", formId);
	document.body.appendChild(searchFormEl);

    var buttonBox = [];
    buttonBox[buttonBox.length] = "        <TR>";
    buttonBox[buttonBox.length] = "          <TD colspan='2' height='46'><div class='buttonBox'>";
    buttonBox[buttonBox.length] = "             <input type='button' class='btStrong btSearch' value='查询'/> - ";
    buttonBox[buttonBox.length] = "             <input type='button' class='btWeak btClose' value='关闭'/>";
    buttonBox[buttonBox.length] = "          </div></TD>";
    buttonBox[buttonBox.length] = "        </TR>";

    var searchForm = $.json2Form(formId, paramConfig, buttonBox.join(""));

    $.cache.XmlDatas[formId] = searchForm.template.sourceXML;
    
    $(".btSearch", searchFormEl).click( function () {
		if( searchForm.checkForm() ) {
			var searchFormXML = $.cache.XmlDatas[formId];
			var dataNode = searchFormXML.querySelector("data");
			searchReport(reportId, dataNode);

			$(searchFormEl).remove();
		}
    });

    $(".btClose", searchFormEl).click( function () {
        $(searchFormEl).remove(); 
    });
}

function searchReport(reportId, dataNode) {
	var request = new $.HttpRequest();
    request.url = "/tss/data/json/" + reportId;
    request.waiting = true;
	request.setFormContent(dataNode);
     
    request.ondata = function() {
		globalValiable.queryParams = this.params;
        globalValiable.data = this.getResponseJSON();

		// TODO 记录当前的条件，在iframeEL上。

		$("#chatFrame" + reportId).show().attr("src", globalValiable.url);
    }
    request.send();
}

// 定时刷新

    </script>  
</body>
</html>