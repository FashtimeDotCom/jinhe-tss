<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<!-- 公共脚本 开始 -->
<link href="../css/css.css" rel="stylesheet" type="text/css">
<link href="../css/dialog.css" rel="stylesheet" type="text/css">
<script language="javascript" src="../js/core.js"></script>
<script language="javascript" src="../js/framework.js"></script>
<!-- 公共脚本 结束 -->

<!-- xform 开始 -->
<link href="htc/xform1.2.3/xform.css" rel="stylesheet" type="text/css">
<!-- xform 结束 -->

<style>
  Xform\:Form {
      behavior:url(htc/xform1.2.3/xform.htc);
  }

</style>
<script language="javascript">
<!--
    /*
     *	后台响应数据节点名称
     */
    XML_USER_NAME = "UserName";
    XML_CLASS_NAME = "ClassName";
    /*
     *	默认唯一编号名前缀
     */
    CACHE_LOGIN_FORM = "login__id";
    /*
     *	XMLHTTP请求地址汇总
     */
    URL_GET_USER_NAME = "data/username.xml";

    URL_GET_USER_NAME = "../getOperatorInfoByLoginName.in";
    /*
     *	函数说明：页面初始化
     *	参数：	
     *	返回值：
     */
    window.onload = function(){
        loadInitData();
    }
    /*
     *	函数说明：初始化数据
     *	参数：	
     *	返回值：
     */
    function loadInitData(){

        var str = [];
        str[str.length] = "<xform>";
        str[str.length] = "    <declare>";
        str[str.length] = "        <column name=\"loginName\" caption=\"登录帐号\" mode=\"string\"/>";
        str[str.length] = "        <column name=\"userName\" caption=\"姓　　名\" mode=\"string\"/>";
        str[str.length] = "        <column name=\"password\" caption=\"密　　码\" mode=\"string\"/>";
        str[str.length] = "        <column name=\"identifier\" caption=\"认证方式\" mode=\"string\"/>";
        str[str.length] = "    </declare>";
        str[str.length] = "    <layout>";
        str[str.length] = "        <TR>";
        str[str.length] = "            <TD width=\"50\"><label binding=\"userName\"/></TD>";
        str[str.length] = "            <TD><input binding=\"userName\" type=\"text\" style=\"width:130px\"/></TD>";
        str[str.length] = "        </TR>";
        str[str.length] = "        <TR>";
        str[str.length] = "            <TD width=\"50\"><label binding=\"password\"/></TD>";
        str[str.length] = "            <TD><input binding=\"password\" type=\"password\" style=\"width:130px\" onkeydown=\"autoLogin()\"/></TD>";
        str[str.length] = "        </TR>";
        str[str.length] = "    </layout>";
        str[str.length] = "    <data>";
        str[str.length] = "        <row/>";
        str[str.length] = "    </data>";
        str[str.length] = "</xform>";

        var xmlReader = new XmlReader();
        xmlReader.loadXML(str.join(""));

        var loginFormNode = new XmlNode(xmlReader.documentElement);
        var loginFormNodeID = CACHE_LOGIN_FORM;

        Cache.XmlIslands.add(loginFormNodeID,loginFormNode);

        initLoginForm(loginFormNodeID);
    }
    /*
     *	函数说明：初始化登录xform
     *	参数：	string:cacheID     缓存数据id
     *	返回值：
     */
    function initLoginForm(cacheID){
        var loginFormObj = document.getElementById("loginForm");
        Public.initHTC(loginFormObj,"isLoaded","oncomponentready",function(){
            loadLoginFormData(cacheID);
        });
    }
    /*
     *	函数说明：角色信息xform加载数据
     *	参数：	string:cacheID     缓存数据id
     *	返回值：
     */
    function loadLoginFormData(cacheID){
        var xmlIsland = Cache.XmlIslands.get(cacheID);
        if(null!=xmlIsland){
            var loginFormObj = document.getElementById("loginForm");
            loginFormObj.load(xmlIsland.node, null, "node");

            loginFormObj.setFocus("userName");

            loginFormObj.ondatachange = function(){
                var name = event.result.name; // event指的是ondatachange这个事件
                var value = event.result.newValue;
                if("userName"==name){
                    getUserName(value, function(userName, identifier){
                        loginFormObj.updateDataExternal("userName", userName, false);
                        loginFormObj.updateDataExternal("identifier", identifier, false);
                        loginFormObj.updateDataExternal("loginName", value, false);
                        loginFormObj.setFocus("password");
                    });
                }
            }
        }
    }
    /*
     *	函数说明：根据用户输入登录帐号loginName返回用户姓名userName
     *	参数：	string:loginName      登录帐号
                function:callback       回调方法
     *	返回值：
     */
    function getUserName(loginName, callback){
        var p = new HttpRequestParams();
        p.url = URL_GET_USER_NAME;
		    p.setContent("loginName", loginName);
		    p.setHeader("appCode", APP_CODE);

        var request = new HttpRequest(p);
        request.onresult = function(){
            var userName = this.getNodeValue(XML_USER_NAME);
            var identifier = this.getNodeValue(XML_CLASS_NAME);
            callback(userName, identifier);
        }
        request.send();
    }
    /*
     *	函数说明：设置返回值并关闭窗口
     *	参数：	
     *	返回值：
     */
    function ok(){
        var loginFormObj = document.getElementById("loginForm");
        var loginName = loginFormObj.getData("loginName")||"";
        var userName = loginFormObj.getData("userName")||"";
        var identifier = loginFormObj.getData("identifier")||"";
        var password = loginFormObj.getData("password")||"";

        //2008-11-7 解决IE7 weglogic下中文登录名乱码问题
        loginName = loginName + "X";
        window.returnValue = {loginName:loginName, userName:userName, password:password, identifier:identifier};
        window.close();
    }
    /*
     *	函数说明：取消并关闭窗口
     *	参数：	
     *	返回值：
     */
    function cancel(){
        window.close();
    }
    /*
     *	函数说明：回车自动提交
     *	参数：	
     *	返回值：
     */
    function autoLogin(){
        if(13==event.keyCode){
            setTimeout(function(){
                ok();
            }, 10);
        }
    }

//-->
</script>
</head>
<body>
<div class="mainBox">
  <table class="full" border="0" cellspacing="0" cellpadding="0">
    <tr>
      <td valign=top>
        <!-- xform 开始 -->
        <Xform:Form id="loginForm" baseurl="htc/xform1.2.3/" editable="true" actionbaseurl=""><div class="loading"></div></Xform:Form>
        <!-- xform 结束 -->
      </td>
    </tr>
    <tr>
      <td align="right" height="30" class="t">
        <input type="button" id="bt_cancel" value="取 消" class="btWeak" onclick="cancel()"> <input type="button" id="bt_ok" value="确 定" class="btStrong" onclick="ok()">
      </td>
    </tr>
  </table>
</div>
</body>
</html>
