<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML xmlns:Tree xmlns:XForm xmlns:Grid>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>文章管理</title>

<link href="../framework/css/css.css" rel="stylesheet" type="text/css"></link>
<link href="../framework/css/dialog.css" rel="stylesheet" type="text/css"></link>
<link href="../framework/menu/menu.css" rel="stylesheet" type="text/css"></link>
<link href="../framework/balloon/balloon.css" rel="stylesheet" type="text/css"></link>
<link href="../framework/xform/xform.css" rel="stylesheet" type="text/css"></link>
<link href="../framework/grid/grid.css" rel="stylesheet" type="text/css"></link>

<script language="javascript" src="../framework/core.js"></script>
<script language="javascript" src="../framework/ajax.js"></script>
<script language="javascript" src="../framework/framework.js"></script>
<script language="javascript" src="../framework/menu/menu.js"></script>
<script language="javascript" src="../framework/balloon/balloon.js"></script>
<script language="javascript" src="../framework/xform/xform.js"></script>
<script language="javascript" src="../framework/grid/grid.js"></script>

<link rel="stylesheet" href="kindeditor-4.1.7/themes/default/default.css" />
<script language="javascript" src="kindeditor-4.1.7/kindeditor-min.js"></script>
<script language="javascript" src="kindeditor-4.1.7/lang/zh_CN.js"></script>

<style>
  .trxx {
	height: 13px;
	background-color:#E4E6F5
  }
</style>

<script type="text/javascript">
<!--
	
	/*
     *	XMLHTTP请求地址汇总
     */
    URL_ARTICLE_DETAIL = "data/article.xml";
    URL_SAVE_ARTICLE = "data/_success.xml";
    URL_SAVE_PUBLISH_ARTICLE = "data/_success.xml";

	var editor;
	var channelId = window.dialogArguments ? window.dialogArguments.channelId : null;
    var articleId = window.dialogArguments ? window.dialogArguments.articleId : null;

	function init() {
		var p = new HttpRequestParams();
        p.url = URL_ARTICLE_DETAIL;

		var request = new HttpRequest(p);
		if(articleId) {
			p.setContent("articleId", articleId);
		}

        request.onresult = function(){
            var articleInfoNode    = this.getNodeValue("ArticleInfo");
            var articleContentNode = this.getNodeValue("ArticleContent");
            var attachsListNode    = this.getNodeValue("AttachsList");

			// 如果是新增，返回的articleId是个临时值（上传附件时会用到）
		    articleId =  articleInfoNode.selectSingleNode(".//data//row").getCDATA("id");

			$X("articleForm", articleInfoNode);

			KindEditor.ready(function(K) {
				editor = K.create('textarea[name="content"]', {
					resizeType : 1
				});
			});
			editor.insertHtml(articleContentNode);

			$G("attachGrid", attachsListNode);

            $$("btSave").onclick  = saveArticle;
            $$("btSaveAndPublish").onclick  = saveAndPublishArticle;
        }
        request.send();
	}
 
    function saveArticle() {
        var articleForm = $X("articleForm");

        // 校验page1Form数据有效性
        if( !articleForm.checkForm() ) {
            return;
        }

        var p = new HttpRequestParams();
        p.url = URL_SAVE_ARTICLE;
        p.setContent("channelId", channelId);

        // 文章基本信息
        var articleInfoNode = new XmlNode(articleForm.getXmlDocument());
		var articleInfoDataNode = articleInfoNode.selectSingleNode(".//data");
		if( articleInfoDataNode ) {
			flag = true;
			p.setXFormContent(articleInfoDataNode);
		}

		// 文章正文
		p.setContent("ArticleContent", $$("content").value);

		// 文章图片附件
		var attachsSeqNos = "";
		p.setContent("attachList", attachsSeqNos.join(","));


        var request = new HttpRequest(p);
       
		// 同步按钮状态
        var btSaveObj = $("btSave");
        syncButton([btSaveObj], request);

        request.onsuccess = function(){
            window.returnValue = true;
            window.close();
        }
        request.send();
    }

     /* 保存并发布文章   */
    function saveAndPublishArticle(){

	}
 
	function uploadFile() {
		var map = {"seqNo":"1", "articleId":"1", "uploadName":"download?id=1", "name":"潜龙勿用", "fileName":"飞龙在天", "type":"图片", "fileExt":"jpg"};
		$G("attachGrid").insertRow(map);
	}

	function deleteFile() {

	}

	window.onload = init;

//-->
</script>

</head>

<body>
<div class="mainBox" id="mainBox">
  <table class="full" border="0" cellspacing="1" cellpadding="0">
    <tr>
      <td>
        <div style="width:100%;height:100%;overflow:auto">
          <table class="hFull" border="0" cellspacing="1" cellpadding="0">
            <tr>
              <td valign="top">
				<XForm:Box id="articleForm" baseurl="../framework/xform/"><div class="loading"></div></XForm:Box>
              </td>
            </tr>
            <tr>
              <td valign="top" height="400">
                  <!-- 编辑器 开始 -->
				  <form>
					<textarea id="content" name="content" style="width:100%;height:399px;visibility:hidden;"></textarea>
				  </form>
                  <!-- 编辑器 结束 -->
              </td>
            </tr>
            <tr>
				<td style="height:120px;">
				   <Grid:Box id="attachGrid" baseurl="../framework/grid/" width="80%" height="120px"></Grid:Box>
				</td>
            </tr>
			 <tr>
				<td style="width:90%;height:50px;">
					 <form id="uploadForm" method="post" enctype="multipart/form-data">
						附件类型: <select name="">
							<option value="1" selected>图片</option>
							<option value="2">附件</option>
						</select>
						<input type="file" name="file"/><input type="button" onclick="uploadFile()" value="上传附件" />
					</form>
				</td>
            </tr>
          </table>
        </div>
      </td>
    </tr>
    <tr>
      <td class="t" height="30" align="center">
        <input type="button" value="关闭" class="btWeak" onclick="window.close()"/> 
		<input type="button" value="完成" class="btStrong" id="btSave"/> 
		<input type="button" value="完成并提交" class="btStrongL" id="btSaveAndPublish"/>
      </td>
    </tr>
  </table>
</div>
</body>
</html>


