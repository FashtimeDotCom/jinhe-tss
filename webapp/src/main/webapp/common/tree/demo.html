<HTML>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>它山石--test XForm</title>

<link href="tree.css" rel="stylesheet" type="text/css">
<link href="../balloon/balloon.css" rel="stylesheet" type="text/css">

<script language="javascript" src="../../js/core.js"></script>
<script language="javascript" src="../../js/ajax.js"></script>
<script language="javascript" src="../../js/framework.js"></script>
<script language="javascript" src="../balloon/balloon.js"></script>

<script language="javascript" src="tree.js"></script>

<SCRIPT LANGUAGE="JavaScript">
<!--
 

/**
 * 事件触发混乱问题，暂时改用模拟事件
 */
function createEventObject() {
	return new Object();
}
function EventFirer(name) {
	var _name = name;
	this.fire = function (event) {
		var func = element.getAttribute(_name);
		if( func ) {
			var funcType = typeof(func);
			if("string" == funcType) {
				eval(func);
			}
			else if ("function" == funcType) {
				func(event);
			}
		}
	}
}

var eventComponentReady = new EventFirer("oncomponentready");
var eventTreeReady = new EventFirer("onLoad");
var eventNodeExpand = new EventFirer("onTreeNodeExpand");
var eventNodeSelected = new EventFirer("onTreeNodeSelected");
var eventNodeActived = new EventFirer("onTreeNodeActived");
var eventNodeDoubleClick = new EventFirer("onTreeNodeDoubleClick");
var eventNodeMoved = new EventFirer("onTreeNodeMoved");
var eventTreeChange = new EventFirer("onChange");
var eventSelectedDefault = new EventFirer("onInitDefaultSelected");
var eventBeforeSelected = new EventFirer("onBeforeSelected");
var eventBeforeActived = new EventFirer("onBeforeActived");
var eventBeforeSelectedAndActived = new EventFirer("onBeforeSelectedAndActived");
var eventNodeRightClick = new EventFirer("onTreeNodeRightClick");


var treeObj = null;
var displayObj = null;
var searchObj = null;
var loador = null;
element.className = _TREE_STYLE;
//element.innerHTML = _TREE_WAIT_LOAD_DATA_MSG;
/*
 * 载入树，如果没有参数dataSrc，则通过控件属性src获取数据；否则根据dataSrc获取数据。
 * 参数：	dataSrc 树数据源（符合树XML规范的xml数据岛id），字符串，可以省略。
 * 返回：	无
 */
function initialize() {
	loador = window.setTimeout(initializeImp, 0);
}
function initializeImp() {
	window.clearTimeout(loador);
	instanceTree();
	instanceDisplay();
	instanceSearch();

	initData();

	//2006-4-6 增加isLoaded属性表示是否初始化完成
	element.isLoaded = true;

	//触发控件初始化完成事件
	eventComponentReady.fire(createEventObject()); 
}

/*
 * 根据id返回TreeNode对象，如果对象不存在，则返回null
 * 参数：	id	节点id，字符串
 * 返回：	TreeNode对象/null
 */
function getTreeNodeById(id) {
	var node = treeObj.getXmlRoot().selectSingleNode(".//treeNode[@id='" + id + "']");
	return instanceTreeNode(node);
}

/* 返回选取节点的TreeNode对象或对象数组
 * 参数：	includeHalfChecked	是否包括半选状态的节点，true为包括，false为不包括。
 * 返回：	单选树：TreeNode对象；多选树：TreeNode对象数组
 * 如果返回的是数组，则数组对象还提供toElement方法，将数组直接转换成xml字符串。
 * 如果includeHalfChecked参数为false，则不包括半选状态的节点，同时toElement方法
 * 给出的xml将所有TreeNode都放到根节点actionSet节点下；否则将给出包括全选、半
 * 选的所有节点，并按原有的节点层次关系给出xml字符串。
 */
function getSelectedTreeNode(includeHalfChecked) {
	return treeObj.getSelectedTreeNode(includeHalfChecked);
}

/* 返回选取节点的Xml对象或对象数组
 * 参数：	includeHalfChecked	是否包括半选状态的节点，true为包括，false为不包括。
 * 返回：	单选树：Xml对象；多选树：Xml对象数组
 * 如果返回的是数组，则数组对象还提供toElement方法，将数组直接转换成xml节点。
 * 如果includeHalfChecked参数为false，则不包括半选状态的节点，同时toElement方法
 * 给出的xml将所有Xml都放到根节点actionSet节点下；否则将给出包括全选、半
 * 选的所有节点，并按原有的节点层次关系给出xml字符串。
 */
function getSelectedXmlNode(includeHalfChecked) {
	return treeObj.getSelectedXmlNode(includeHalfChecked);
}

/*
 * 获取当前激活节点的TreeNode对象。如果没有激活的对象，则返回null。
 * 返回：	TreeNode对象
 */
function getActiveTreeNode() {
	return treeObj.getActiveNode();
}

/*
 * 设定相应id的节点为激活状态。
 * 参数：id 字符串，所要激活的节点的id，必须提供，否则会报错。
 * 返回：	无
 * 如果相应id的节点尚未被打开，也就是其父节点或父节点的父节点等没有被打开，那么先打开此节点。
 * 然后激活此节点，同时根据treeNodeSelectAndActive属性，确定是否同时改变节点选择状态。
 */
function setActiveTreeNode(id) {
	var treeNode = getTreeNodeById(id);
	if(treeNode instanceof TreeNode) {
		treeNode.setActive();	//激活节点，同时根据treeNodeSelectAndActive属性，确定是否同时改变节点选择状态。
		treeObj.setActiveNode(treeNode);
		treeNode.focus();		//打开节点，让节点出现在可视区域内。
	}
}

/*
 * 新增子节点，同时激活新节点
 * 参数：	newNodeXML	新节点合法的xml
 *			parentTreeNode	父节点合法的TreeNode对象
 * 返回：	true/false
 */
function insertTreeNodeXml(newNodeXML, parentTreeNode) {
	if(!(parentTreeNode instanceof TreeNode)) {
		return false;
	}
	var treeNode = parentTreeNode.appendChild(newNodeXML);		//新增子节点
	if(!(treeNode instanceof TreeNode)) {
		return false;
	}
	if(treeObj.isFocusNewTreeNode()) {
		treeNode.setActive();	//激活节点，同时根据treeNodeSelectAndActive属性，确定是否同时改变节点选择状态。
		treeNode.focus();		//打开节点，让节点出现在可视区域内。
	}else{
		parentTreeNode.setActive();
		parentTreeNode.open();
	}
	return true;
}

/*
 * 删除节点
 * 参数：	treeNode	节点的TreeNode对象
 * 返回：	true/false
 */
function removeTreeNode(treeNode) {
	//alert(treeNode instanceof TreeNode);
	if(!(treeNode instanceof TreeNode)) {
		return false;
	}
	var result = treeNode.remove();		//删除节点
	displayObj.reload();
	return result;
}

/*
 * 跟据目标节点和移动状态，移动节点位置。
 * 参数：	movedTreeNode	移动节点TreeNode对象
 *			toTreeNode		目标节点TreeNode对象
 *			moveState		移动状态，-1为目标节点上方，1为目标节点下方
 * 返回：	true/false
 */
function moveTreeNode(movedTreeNode, toTreeNode, moveState) {
	if(!treeObj.isCanMoveNode()
		|| !(movedTreeNode instanceof TreeNode)
		|| !(toTreeNode instanceof TreeNode)) {
		return false;
	}
	var result = movedTreeNode.moveTo(toTreeNode, moveState);	//移动节点
	displayObj.reload();
	return result;
}

/*
 * 跟据目标节点和移动状态，从外部（其他树）移动节点位置。
 * 参数：	movedTreeNode	移动外部（其他树）的节点TreeNode对象
 *			toTreeNode		目标节点TreeNode对象
 *			moveState		移动状态，-1为目标节点上方，1为目标节点下方
 * 返回：	true/false
 */
function moveExternalTreeNode(movedTreeNode, toTreeNode, moveState) {

	var movedTreeNodeId = movedTreeNode.getId();
	var movedTreeNodeXml = movedTreeNode.getXmlNode().xml;
	var toTreeNodeParent = toTreeNode.getParent();

	if(toTreeNodeParent.getXmlNode().nodeName=="actionSet") {//根节点
		var newRootTreeNode = new TreeNode();		//新增根节点
		newRootTreeNode.appendRoot(movedTreeNodeXml);
	}else{//枝节点
		insertTreeNodeXml(movedTreeNodeXml,toTreeNodeParent);
	}
		
	var newNode = getTreeNodeById(movedTreeNodeId);
	moveTreeNode(newNode,toTreeNode,moveState);

	var newNode = getTreeNodeById(movedTreeNodeId);
	newNode.setActive();	//激活节点，同时根据treeNodeSelectAndActive属性，确定是否同时改变节点选择状态。
	newNode.focus();		//打开节点，让节点出现在可视区域内。
}

/*
 * 获取树的标题
 * 参数：
 * 返回值：树标题字符串
 * 作者：scq
 * 时间：2004-6-14
 */
function getTreeTitle() {
	try{
		var title = treeObj.getXmlRoot().getAttribute("title");
		if(isNullOrEmpty(title)) {
			return "选择";
		}else{
			return title;
		}
	}catch(e) {
		alert("不能获取标题，xml数据为空或不能解析");
		throw(e);
	}
}
/*
 * 设定默认选中节点
 * 参数：	type	默认选中类型
 * 返回值：
 * 作者：scq
 * 时间：2005-11-17
 */
function setDefaultActive(type) {
	treeObj.setDefaultActive(type);
}
/*
 * 通过xml节点、数据岛、数据文件或xml字符串，重新载入数据源
 * 参数：	dataSrc	数据岛或者xml节点
 * 返回值：
 * 作者：scq
 * 时间：2004-7-2
 */
function loadXML(dataSrc) {
	treeObj.loadData(dataSrc);
	treeObj.setDefaultActive();
	displayObj.resetTotalTreeNodes();
	displayObj.reload();
	//触发载入完成事件
	eventTreeReady.fire(createEventObject()); 
}
function load (dataSrc) {
	loadXML(dataSrc);
}
function reload () {
	displayObj.resetTotalTreeNodes();
	displayObj.reload();
}
/*
 * 初始化数据和默认选中状态
 * 返回值：
 * 作者：scq
 * 时间：2004-12-23
 */
function initData() {
	treeObj.loadData();
	treeObj.setNodesChecked();
	treeObj.setDefaultActive();
	displayObj.resetTotalTreeNodes();
	displayObj.reload();
	//触发载入完成事件
	eventTreeReady.fire(createEventObject()); 
}
/*
 * 根据给定的数据，处理树节点的默认选中状态
 * 参数：	selectedSrc	默认选中的数据
 *		clearOldSelected	是否清除原先选中节点
 * 返回值：
 * 作者：沈超奇
 * 时间：2004-12-23
 */
function loadDefaultChecked(selectedSrc, clearOldSelected) {
	treeObj.setNodesChecked(selectedSrc, clearOldSelected);
	displayObj.resetTotalTreeNodes();
	displayObj.reload();
	var eventObj = createEventObject();
	eventObj.type = "_SelectedDefalt";
	eventSelectedDefault.fire(eventObj);
}
/*
 * 根据给定的数据，处理树节点的默认选中状态
 * 参数：	selectedIds	默认选中的数据(id字符串，多个id用“,”隔开)
 *		clearOldSelected	是否清除原先选中节点
 *		isDependParent	    是否依赖父节点(父节点选中，则所有子节点均选中)
 * 返回值：
 * 作者：沈超奇
 * 时间：2005-4-19
 */
function loadDefaultCheckedByIds(selectedIds, clearOldSelected, isDependParent) {
	treeObj.setNodesCheckedByNodeIDs(selectedIds, clearOldSelected, isDependParent);
	displayObj.resetTotalTreeNodes();
	displayObj.reload();
	var eventObj = createEventObject();
	eventObj.type = "_SelectedDefalt";
	eventSelectedDefault.fire(eventObj);
}

/*
 * 获取ids，所有节点的id字符串，默认为所有选中状态(全选、半选)的节点id字符串
 * 参数：isAll	是否为全部节点的Id
 *       onlySelected	只包括全选的
 *	 exIdPatterns	匹配不包含的Id的正则表达式数组
 * 返回：	id，字符串：id1,id2,id3
 */
function getIds(isAll, onlySelected, exIdPatterns) {
	if(isAll) {
		var path = ".//treeNode" ;
	}else{
		if(onlySelected) {
			var path = ".//treeNode[@checktype='1']";
		}else{
			var path = ".//treeNode[@checktype='1' or @checktype='2']";
		}
	}
	var nodes = treeObj.getXmlRoot().selectNodes(path);
	var ids = "";
	node:
	for(var i = 0; i < nodes.length; i++) {
		var id = nodes[i].getAttribute(_TREE_NODE_ID);
		if(id == _TREE_ROOT_NODE_ID) {
			continue;
		}
		if(exIdPatterns != null) {
			for(var j = 0; j < exIdPatterns.length; j++) {
				if(exIdPatterns[j].test(id)) {
					continue node;
				}
			}
		}
		if(ids.length > 0) {
			ids += ",";
		}
		ids += id;
	}
	return ids;
}

 

/*
 * 查询得到所有符合要求的结果
 * 参数：	searchStr	查询的字符串
 *			searchField	查询的属性名称
 *			searchType	查询方式：hazy(模糊)/rigor(精确)，默认为rigor
 *			direct		查询方向
 */	
function searchNode(searchStr, searchField, searchType, direct) {
	if(searchObj.search(searchStr, searchField, searchType)) {
		searchObj.first(direct);
	}
}

/*
 * 获取查询结果的下一个结果
 * 参数：
 *			direct		查询方向：默认为向下查询
 *			isCircle	是否循环查询，默认为不循环查询
 */	
function searchNext(direct, isCircle) {
	searchObj.next(direct, isCircle);
}







/*
 * 禁止选取控件中文字事件
 * 参数：
 * 返回值：
 * 作者：scq
 * 时间：2004-7-1
 */
function _onselectstart() {
	event.returnValue = false;
	return false;  
}

/*
 * 鼠标双击响应函数，触发自定义双击事件。
 * 参数：
 * 返回值：
 * 作者：scq
 * 时间：2004-7-1
 */
function _ondblclick() {
	var eventObj = window.event.srcElement;
	var row = getRow(eventObj);
	if(row instanceof Row) {
		var treeNode = instanceTreeNode(row.node);
	}
	if(!(row instanceof Row) || !(treeNode instanceof TreeNode) || !treeNode.isCanSelected() || (eventObj != row.label && eventObj != row.icon)) {	
		return;
	}
	//触发双击事件
	var eventObj = createEventObject();
	eventObj.treeNode = treeNode;
	eventNodeDoubleClick.fire(eventObj);
}

/*
 * 	鼠标右键单击事件响应函数
 *			如果点击的是文字连接，则激活该节点，同时触发右键单击事件。
 * 参数：
 * 返回值：
 * 作者：毛云
 * 时间：2006-5-7
 */
function _oncontextmenu() {
	var eventObj = window.event.srcElement;
	window.event.returnValue = false;
	var row = getRow(eventObj);
	if(row instanceof Row) {
		var treeNode = instanceTreeNode(row.node);
	}
	if(!(row instanceof Row) || !(treeNode instanceof TreeNode)) {
		return;
	}
    //设置节点为激活
    if(true==treeNode.isCanSelected()) {
        treeObj.setActiveNode(treeNode);
    }

    //触发右键激活节点事件
    var eventObj = createEventObject();
    eventObj.treeNode = treeNode;
    eventObj.clientX = event.clientX;
    eventObj.clientY = event.clientY;
    eventNodeRightClick.fire(eventObj);

	displayObj.reload();
    
}

/*
 * 	鼠标单击事件响应函数
 *			如果点击的是选择状态图标，则改变选择状态，同时根据treeNodeSelectAndActive属性，确定是否同时激活该节点。
 *			如果点击的是伸缩状态图标，则打开或收缩当前节点的直系子节点。
 *			如果点击的是文字连接，则激活该节点，同时根据treeNodeSelectAndActive属性，确定是否同时改变节点选择状态。
 * 参数：
 * 返回值：
 * 作者：scq
 * 时间：2004-7-1
 */
function _onclick() {
	var eventObj = window.event.srcElement;
	window.event.returnValue = false;
	var row = getRow(eventObj);
	if(row instanceof Row) {
		var treeNode = instanceTreeNode(row.node);
	}
	if(!(row instanceof Row) || !(treeNode instanceof TreeNode)) {
		return;
	}
	if(eventObj == row.checkType) {		//根据不同的treeType，改变相应的选择状态
		treeNode.changeSelectedState(window.event.shiftKey);
	}else if(eventObj == row.folder) {
		treeNode.changeFolderState();		//展开、收缩节点的直系子节点
	}else if(eventObj == row.label || eventObj == row.icon) {
		if(treeObj.isTreeNodeToOpenOnClick()) {
			//2006-4-22 只有当枝节点才允许执行
			if(treeNode.node.hasChildNodes()) {
				//点击节点文字时，改变节点伸缩状态
				treeNode.changeFolderState();
			}
		}
		treeNode.setActive(window.event.shiftKey);		//激活节点
	}
	displayObj.reload();
}

//鼠标移到节点上
/*
 * 鼠标移到元素上。
 * 参数：
 * 返回值：
 * 作者：scq
 * 时间：2004-7-1
 */
function _onmouseover() {
	var obj = window.event.srcElement;
	var row = getRow(obj);
	if(!(row instanceof Row) || row.label != obj) {
		return;
	}
	row.setClassName(treeObj.getStyleClass(row.node, _TREE_NODE_OVER_STYLE));
}
//鼠标离开节点
/*
 * 鼠标离开元素时。
 * 参数：
 * 返回值：
 * 作者：scq
 * 时间：2004-7-1
 */
function _onmouseout() {
	var obj = window.event.srcElement;
	var row = getRow(obj);
	if(!(row instanceof Row) || row.label != obj) {
		return;
	}
	row.setClassName(treeObj.getStyleClass(row.node));
}

///////////////////////	以下函数用于节点拖动 ////////////////////////////

/*
 * 开始拖动事件响应，设定拖动节点
 * 参数：
 * 返回值：
 * 作者：scq
 * 时间：2004-7-1
 */
function _ondragstart() {
	if(!treeObj.isCanMoveNode()) {		//确定是否提供拖动节点功能
		return;
	}
	var obj = window.event.srcElement;
	var row = getRow(obj);
	if(!(row instanceof Row) || obj != row.label) {
		return;
	}
	var node = row.node;
	//设定拖动节点
	treeObj.setMovedNode(node);

	//2006-4-7 调整为全局
	//element.movedNode = node;
	//element.movedNodeScrollTop = displayObj.getScrollTop() + getTop(obj);
	//element.movedRow = obj;
	var tempData = {};
	tempData.moveTree = element;
	tempData.movedNode = node;
	tempData.movedNodeScrollTop = displayObj.getScrollTop() + getTop(obj);
	tempData.movedRow = obj;
	window._dataTransfer = tempData;

	row.setClassName(_TREE_NODE_MOVED_STYLE);
	window.event.dataTransfer.effectAllowed = "move";
}

/*
 * 拖动完成，触发自定义节点拖动事件
 * 参数：
 * 返回值：
 * 作者：scq
 * 时间：2004-7-1
 */
function _ondrop() {
	if(!treeObj.isCanMoveNode()) {		//同上
		return;
	}
	stopScrollTree();
	var obj = window.event.srcElement;
	obj.runtimeStyle.borderBottom = _TREE_NODE_MOVE_TO_HIDDEN_LINE_STYLE;
	obj.runtimeStyle.borderTop = _TREE_NODE_MOVE_TO_HIDDEN_LINE_STYLE;
	//触发自定义事件
	var eObj = createEventObject();
	eObj.movedTreeNode = instanceTreeNode(window._dataTransfer.movedNode);
	eObj.toTreeNode = instanceTreeNode(window._dataTransfer.toNode);
	eObj.moveState = window._dataTransfer.moveState;
	//2006-4-7 增加被拖动的节点所在树
	eObj.moveTree = window._dataTransfer.moveTree;
	eventNodeMoved.fire(eObj);
}

/*
 * 拖动结束，去除拖动时添加的样式
 * 参数：
 * 返回值：
 * 作者：scq
 * 时间：2004-7-1
 */
function  _ondragend() {
	if(!treeObj.isCanMoveNode()) {		//同上
		return;
	}
	stopScrollTree();
	var obj = window.event.srcElement;
	var row = getRow(obj);
	if(!(row instanceof Row) || obj != row.label) {
		return;
	}
	obj.runtimeStyle.borderBottom = _TREE_NODE_MOVE_TO_HIDDEN_LINE_STYLE;
	obj.runtimeStyle.borderTop = _TREE_NODE_MOVE_TO_HIDDEN_LINE_STYLE;
	treeObj.setMovedNode(null);
	displayObj.reload();
}

/*
 * 拖动时，鼠标进入节点，设定目标节点和拖动状态
 * 参数：
 * 返回值：
 * 作者：scq
 * 时间：2004-7-1
 */
function _ondragenter() {
	if(!treeObj.isCanMoveNode()) {		//同上
		return;
	}
    if(null==window._dataTransfer) {
        return;
    }
	var obj = window.event.srcElement;
	//判断是否需要滚动树，如是则相应的滚动
	startScrollTree(obj);
	var row = getRow(obj);
	if(row instanceof Row) {
		var node = row.node;
	}

	//2006-4-7 区分是否同一棵树
	if(!(row instanceof Row)
		|| obj != row.label) {		//拖动的不是文字链接，则无效
		return;
	}
	//是同一棵树
	if(window._dataTransfer && window._dataTransfer.moveTree==element) {
		if(window._dataTransfer.movedNode == null
			|| node.parentNode != window._dataTransfer.movedNode.parentNode	//不是兄弟节点无效
			|| obj == window._dataTransfer.movedRow) {		//目标节点相同无效
			return;
		}
	}else{
	}

	window._dataTransfer.toNode = node;
	if(displayObj.getScrollTop() + getTop(obj) > window._dataTransfer.movedNodeScrollTop) {
		window._dataTransfer.moveState = 1;
		obj.runtimeStyle.borderBottom = _TREE_NODE_MOVE_TO_LINE_STYLE;
	}else{
		window._dataTransfer.moveState = -1;
		obj.runtimeStyle.borderTop = _TREE_NODE_MOVE_TO_LINE_STYLE;
	}
	window.event.returnValue = false;
	window.event.dataTransfer.dropEffect = "move";
}

/*
 * 拖动时，鼠标离开节点
 * 参数：
 * 返回值：
 * 作者：scq
 * 时间：2004-7-1
 */
function _ondragleave() {
	if(!treeObj.isCanMoveNode()) {
		return;
	}
	stopScrollTree(obj);
	var obj = window.event.srcElement;
	var row = getRow(obj);
	if(!(row instanceof Row) || obj != row.label) {
		return;
	}
	obj.runtimeStyle.borderBottom = _TREE_NODE_MOVE_TO_HIDDEN_LINE_STYLE;
	obj.runtimeStyle.borderTop = _TREE_NODE_MOVE_TO_HIDDEN_LINE_STYLE;
	window.event.dataTransfer.dropEffect = "none";
}
/////////////////////////////// 节点拖动结束 /////////////////////////////

   
//-->
</SCRIPT>
</head>

<body>
 
</body>
</html>