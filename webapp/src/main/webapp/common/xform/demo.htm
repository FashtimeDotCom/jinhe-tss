<HTML XMLNS:XFORM>
<head>
<!-- <BASE href="E:\项目\通用模块\XForm\XForm_1.2\"/> -->
<link href="xform.css" rel="stylesheet" type="text/css">
<style>
	a.history {
		border:1px solid #F6F6FF;
	}
	a.history:hover {
		border-left:1px solid white;
		border-top:1px solid white;
		border-right:1px solid #CCCCCC;
		border-bottom:1px solid #CCCCCC;
	}
	div.history{
		position:absolute;
		width:100px;
		height:10px;
		padding:5px;
		border:1px solid black;
		background-color:#FFFFEE;
		font-size:12px;
	}
	div.history *{
		font-size:12px;
	}
	xform\:form table{
		background-color:#F6F6FF;
	}
</style>
</head>


<SCRIPT LANGUAGE="JavaScript">
<!--

	function test(){
		document.all.xform1.reload();

		//此处模拟获取树节点相应属性来构建xform用的数据节点row
		var tempRowNode = form_a.createElement("row");
		tempRowNode.setAttribute("inCode",new Date().valueOf().toString(10));
		tempRowNode.setAttribute("typeId","2");

		//刷新xform数据显示
		xform1.reloadData(tempRowNode);
		xform1.saveasDefaultValue();

	}
//-->
</SCRIPT>
<body>
<xml id=form_a>
	<forms>
		<query action="#" onsubmit="alert('onsubmit event')" method="get">
			<declare moneyUnit="10" moneyUnitLabel="角" moneyPattern="###,##0.0" moneyReg="/^\\-?\\d{1,16}$/">
				<column name="user" caption="用户名" mode="string" inputReg="/^\d{0,6}(\.\d{0,2})?$/" pattern="###,##0.00" editablex="false"/>
				<column name="password" caption="口令" mode="string" editable="true" empty="false"/>
				<column name="id" caption="" mode="hidden" editable="true"/>
				<column name="date" caption="日期" mode="date" editable="true" pattern="yyyy/MM/dd"/>
				<column name="special" caption="科室" mode="function" editable="true" cmd="confirm('假装选择树');xform1.updateDataExternal('special','abc')"/>
				<column name="test" caption="test" mode="string" empty="false"/>
			</declare>
			<layout>
				<TR>
					<TD align="right" width="100"><label binding="user"/></TD>
					<TD><textarea binding="user" type="text" style="background-color:#E5E9F2;width:200px;height:100px"/></TD>
				</TR>
				<TR>
					<TD align="right"><label binding="password"/></TD>
					<TD><INPUT binding="password" type="text" editorvalue="1|2|3" editortext="aaa|bbb|ccc" style="width:300px"/></TD>
				</TR>
				<TR>
					<TD align="right"><label binding="date"/></TD>
					<TD><INPUT binding="date" style="background-color:#E5E9F2;width:200px"/></TD>
				</TR>
				<TR>
					<TD align="right"><label binding="special"/></TD>
					<TD><input binding="special" type="radio" editorvalue="a|b|c" editortext="测试1|测试2|测试3"/></TD>
				</TR>
				<buttonset>
					<input type="submit" value="确定"/>
					<input type="reset" value="重置"/>
					<input type="button" value="关闭" onclick="window.close()"/>
				</buttonset>
			</layout>
			<data>
				<row user="2222" password="aaaaaaaaa" id="222" date="2005/09/09" special="b"/>
			</data>
			<extend>
				<histories>
					<history binding="date">
						<row id="张三" date="2005/09/09" value="2005/04/06"/>
						<row id="李四" date="2005/12/22" value="2005/04/16"/>
						<row id="王五" date="2005/12/31" value="2005/05/06"/>
					</history>
					<history binding="user">
						<row id="张三" date="2005/09/09" value="1234"/>
						<row id="李四" date="2005/12/22" value="按时打发十分"/>
						<row id="王五" date="2005/12/31" value="gdsdfg"/>
					</history>
				</histories>
			</extend>
		</query>
		<xform action="#" onsubmit="" method="get" queryName="getEntitiesByYear_Options" getTreeUtilClass="com.hzzk.common.xform.BaseInfoTreeByYear" querySonsNum="querySonsNumByPId_Options" querySons="getEntitiesByPId_Options" className="com.hzzk.baseinfo.entity.baseinfo.Options" modelCaption="选项表" submitCmd="checkLength(_ancestor)">
			<declare>
				<column name="guId" caption="内部序号" mode="string" editable="false"/>
				<column name="code" caption="操作码" mode="string"/>
				<column name="name" caption="名称" mode="string" empty="false"/>
				<column name="type" caption="表类型" mode="string"/>
				<column name="description" caption="描述" mode="string"/>
			</declare>
			<script>
				<![CDATA[
			function checkLength(_ancestor){]]><![CDATA[
				var code = _ancestor.getData("code");]]><![CDATA[
				var name = _ancestor.getData("name");]]><![CDATA[
				var description = _ancestor.getData("description");]]><![CDATA[

				if(code.replace(/[^\u0000-\u00ff]/g, "**").length > 30){]]><![CDATA[
					_ancestor.showCustomErrorInfo("code","操作码长度不能大于30个字符");]]><![CDATA[
					return false; ]]><![CDATA[
				}]]><![CDATA[

				if(name.replace(/[^\u0000-\u00ff]/g, "**").length > 60){]]><![CDATA[
					_ancestor.showCustomErrorInfo("name","名称长度不能大于60个字符");]]><![CDATA[
					return false;]]><![CDATA[
				}]]><![CDATA[
					]]><![CDATA[
				if(description.replace(/[^\u0000-\u00ff]/g, "**").length > 200){]]><![CDATA[
					_ancestor.showCustomErrorInfo("description","描述长度不能大于200个字符");]]><![CDATA[
					return false;]]><![CDATA[
				}]]><![CDATA[
			}]]><![CDATA[
			]]>
			</script>
			<layout>
				<TR>
					<TD width="20%">内部序号</TD>
					<TD>
						<input binding="guId" type="text" style="background-color:#E5E9F2;width:200"/>
					</TD>
				</TR>
				<TR>
					<TD width="20%">操作码</TD>
					<TD>
						<input binding="code" type="text" style="background-color:#E5E9F2;width:200"/>
					</TD>
				</TR>
				<TR>
					<TD width="20%">名称</TD>
					<TD>
						<input binding="name" type="text" style="background-color:#E5E9F2;width:200"/>
					</TD>
				</TR>
				<TR>
					<TD width="20%">表类型</TD>
					<TD>
						<input binding="type" type="text" style="background-color:#E5E9F2;width:200"/>
					</TD>
				</TR>
				<TR>
					<TD width="20%">描述</TD>
					<TD>
						<textarea binding="description" type="textarea" style="background-color:#E5E9F2;width:200"/>
					</TD>
				</TR>
			</layout>
			<data></data>
		</xform>
	</forms>
</xml>
<TABLE width=100%>
<TR valign=top>
	<TD height=300>
		<XFORM:FORM id="xform1" data="form_a" datapath="/forms/query[0]" style="behavior:url(XForm.htc);" baseurl="" editable="true" actionbaseurl="" caption="测试<input type=button value='折叠' style='position:absolute;right:2px;height:16px;top:1px' onclick='collapseXForm(this,xform1)'>" onload="initXForm()" ondatachange="debug.value=('event:\r\nold:'+event.result.oldValue+'\r\nnew:'+event.result.newValue+'\r\nobj:'+event.result.srcElement)"/>


<SCRIPT LANGUAGE="JavaScript">
<!--
	function initXForm(){

		//查找是否有历史修改记录
		checkHistory("date");
		checkHistory("user");
	
	
	}
	function collapseXForm(btObj,xformObj){
		if(xformObj.style.overflow=="hidden"){
			btObj.value = "折叠";
			xformObj.style.height = "";
			xformObj.style.overflow = "visible";
		}else{
			btObj.value = "展开";
			xformObj.style.height = "22px";
			xformObj.style.overflow = "hidden";
		}
	}

	function checkHistory(name){
	
		var tempHistoryNode = xform1.getXmlDocument().selectSingleNode("./extend/histories/history[@binding='"+name+"']");
		if(tempHistoryNode!=null){
			var tempHistoryRows = tempHistoryNode.selectNodes("./row");
			if(tempHistoryRows.length>0){
				var tempCaption = xform1.getColumnAttribute(name,"caption");

				//已经有历史修改记录	
				xform1.setLabelContent(name,"<span style='color:red'>" + tempCaption + "</span><a class='history' href='#' id='bt_history'><img src='history.gif' width='16' height='16' align='absmiddle' border='0'/></a>");

				var bt = document.getElementById("bt_history");
				if(bt!=null){
					bt.hideHistory = function(){					
						var layer = document.getElementById("layer_history");
						if(layer!=null){
							layer.style.visibility = "hidden";
						}
					}
					bt.showHistory = function(){	
						var layer = document.getElementById("layer_history");
						if(layer==null){						
							document.body.insertAdjacentHTML("beforeEnd","<div id='layer_history' class='history' nowrap></div>");
							layer = document.getElementById("layer_history");
						}else{
							layer.style.visibility = "visible";
						}
						layer.style.left = event.clientX;
						layer.style.top = event.clientY;

						//获取历史信息内容
						var content = [];
						content[content.length] = "<TABLE width=100%><TR><TD width=50 nowrap>更改人</TD><TD width=80 nowrap>日期</TD><TD width=80 nowrap>更改为</TD></TR>";
						for(var i=0;i<tempHistoryRows.length;i++){
							var curHistoryRow = tempHistoryRows[i];
							content[content.length] = "<TR><TD nowrap>" + curHistoryRow.getAttribute("id") + "</TD><TD nowrap>" + curHistoryRow.getAttribute("date") + "</TD><TD nowrap>" + curHistoryRow.getAttribute("value") + "</TD></TR>";
						}
						content[content.length] = "</TABLE>";

						layer.innerHTML = content.join("");
						
						var thisObj = this;
						layer.onmouseover = function(){
							clearTimeout(thisObj.timeout);
						}
						layer.onmouseout = function(){
							thisObj.timeout = setTimeout(function(){
								thisObj.hideHistory();
							},1000);
						}
						layer.onclick = function(){
							alert(this.outerHTML);
						}
					}
					bt.onclick = function(){
						event.returnValue = false;
						clearTimeout(this.timeout);

						this.showHistory();

						var thisObj = this;
						this.timeout = setTimeout(function(){
							thisObj.hideHistory();
						},1000);
					}
					bt.onblur = function(){
						event.returnValue = false;
						clearTimeout(this.timeout);

						this.hideHistory();
					}
				}
			}
		}
	}
//-->
</SCRIPT>


		<!-- <input type=button value="alert" onclick="alert(form_a.selectSingleNode('/forms/query[0]/data').xml)">

		<XFORM:FORM id="xform2" data="form_a" datapath="/forms/xxx[0]" style="behavior:url(XForm.htc);" baseurl="" caption="aasdfsdf" ondatachangex="alert('event1:'+event.result.newValue)" onloadx="alert('111:'+this.id)" onloadPriority="true" ondatachangePriority="true"/> -->
	</TD>
</TR>
<TR>
	<TD>
		<input type=button value="test" onclick="xform1.updateDataExternal('test','')">
		<input type=button value="check" onclick="debug.value=(xform1.checkForm())">
		<!-- <input type=button value="debug.value" onclick="debug.value=xform1.xml()">
		<input type=button value="alert" onclick="xform1.updateDataExternal('date','2005.5.6',true)">
		<input type=button value="editable" onclick="xform1.setEditable('true')">
		<input type=button value="test" onclick="debug.value=(xform1.checkForm())"> -->
		<textarea id=debug cols=80 rows=20></textarea>
	</TD>
</TR>
</TABLE>

</body>