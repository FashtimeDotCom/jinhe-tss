<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html xmlns:ToolBar xmlns:Grid2 xmlns:WorkSpace xmlns:Xform xmlns:Tree>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>应用支撑平台</title>

<!-- 公共脚本 开始 -->
<link href="css/css.css" rel="stylesheet" type="text/css">
<script language="javascript" src="js/core.js"></script>
<script language="javascript" src="js/framework.js"></script>
<!-- 公共脚本 结束 -->

<!-- 气球 开始 -->
<link href="common/balloon/balloon.css" rel="stylesheet" type="text/css">
<script language="javascript" src="common/balloon/balloon.js"></script>
<!-- 气球 结束 -->

<!-- xform 开始 -->
<link href="common/xform/xform.css" rel="stylesheet" type="text/css">
<!-- xform 结束 -->

<!-- 当前页相关脚本 开始 -->
<style>
  Xform\:Form {
      behavior:url(common/xform/xform.htc);
  }
</style>

<SCRIPT LANGUAGE="JavaScript">
<!--
    /*
     *	后台响应数据节点名称
     */
    XML_USER_NAME = "UserName";
    XML_CLASS_NAME = "ClassName";

    /*
     *	默认唯一编号名前缀
     */
    CACHE_LOGIN_FORM = "login__id";

    /*
     *	XMLHTTP请求地址汇总
     */
    URL_GET_USER_NAME = "test/mockdata/username.xml";
    URL_LOGIN = "test/mockdata/_success.xml";

//    URL_GET_USER_NAME = "getOperatorInfoByLoginName.in";
//    URL_LOGIN = "login.do";
 
    /*
     *	页面初始化
     */
    function init(){
        loadInitData();
    }

    /*
     *	初始化数据
     */
    function loadInitData(){
        var str = [];
        str[str.length] = "<xform>";
        str[str.length] = "    <declare>";
        str[str.length] = "        <column name=\"userName\"   caption=\"账　　号\" mode=\"string\"/>";
        str[str.length] = "        <column name=\"loginName\"  caption=\"登录帐号\" mode=\"string\"/>";
        str[str.length] = "        <column name=\"password\"   caption=\"密　　码\" mode=\"string\"/>";
        str[str.length] = "        <column name=\"identifier\" caption=\"认证方式\" mode=\"string\"/>";
        str[str.length] = "    </declare>";
        str[str.length] = "    <layout>";
        str[str.length] = "        <TR>";
        str[str.length] = "            <TD width=\"50\"><label binding=\"userName\"/></TD>";
        str[str.length] = "            <TD><input binding=\"userName\" type=\"text\" style=\"width:150px\"/></TD>";
        str[str.length] = "        </TR>";
        str[str.length] = "        <TR>";
        str[str.length] = "            <TD width=\"50\"><label binding=\"password\"/></TD>";
        str[str.length] = "            <TD><input binding=\"password\" type=\"password\" style=\"width:150px\" onkeydown=\"autoLogin()\"/></TD>";
        str[str.length] = "        </TR>";
        str[str.length] = "        <TR>";
        str[str.length] = "            <TD width=\"50\">&amp;nbsp;</TD>";
        str[str.length] = "            <TD><a href=\"#\" onclick=\"register()\">新用户注册</a> | <a href=\"#\" onclick=\"forget()\">忘记密码</a></TD>";
        str[str.length] = "        </TR>";
        str[str.length] = "        <TR>";
        str[str.length] = "            <TD width=\"50\">&amp;nbsp;</TD>";
        str[str.length] = "            <TD><input type=\"button\" class=\"btLogin\" id=\"btCancel\" value=\"重置\" onclick=\"resetForm()\"/><input type=\"button\" class=\"btLogin\" id=\"btLogin\" value=\"登录\" onclick=\"login()\"/></TD>";
        str[str.length] = "        </TR>";
        str[str.length] = "    </layout>";
        str[str.length] = "    <data>";
        str[str.length] = "        <row/>";
        str[str.length] = "    </data>";
        str[str.length] = "</xform>";

        var xmlReader = new XmlReader(str.join(""));

        var loginFormNode = new XmlNode(xmlReader.documentElement);
        var loginFormNodeID = CACHE_LOGIN_FORM;

        Cache.XmlIslands.add(loginFormNodeID, loginFormNode);

		// 初始化登录xform
		var loginFormObj = $("loginForm");
        Public.initHTC(loginFormObj, "isLoaded", "oncomponentready", function() {
			loginFormObj.load(loginFormNode.node, null, "node");
			loginFormObj.ondatachange = function() {
                var name  = event.result.name;
                var value = event.result.newValue;
                if("userName" == name){
                    getUserName(value, function(userName, identifier) {
                        loginFormObj.updateDataExternal("userName", userName, false);
                        loginFormObj.updateDataExternal("identifier", identifier, false);
                        loginFormObj.updateDataExternal("loginName", value, false);
                        loginFormObj.setFocus("password");
                    });
                }
            }
        });
    }
 
    /*
     *	根据用户输入登录帐号返回用户姓名
     *	参数：	string:loginName      登录帐号
                function:callback     回调方法
     */
    function getUserName(loginName, callback) {
        var p = new HttpRequestParams();
        p.url = URL_GET_USER_NAME;
		p.setContent("loginName", loginName);
		p.setHeader("appCode", APP_CODE);

        var request = new HttpRequest(p);
        request.onexception = function() {
            var loginFormObj = $("loginForm");
            loginFormObj.setFocus();
        }
        request.onresult = function(){
            var userName   = this.getNodeValue(XML_USER_NAME);
            var identifier = this.getNodeValue(XML_CLASS_NAME);

            callback(userName, identifier);
        }
        request.send();
    }

    function login() {
        // 校验loginForm数据有效性
        var loginFormObj = $("loginForm");
        var userName = loginFormObj.getData("userName") || "";
        var password = loginFormObj.getData("password") || "";
        if( "" == userName ) {
            loginFormObj.showCustomErrorInfo("userName", "请输入姓名");
            return;
        } 
		else if( "" == password ) {
            loginFormObj.showCustomErrorInfo("password", "请输入密码");
            return;
        }

        var p = new HttpRequestParams();
        p.url = URL_LOGIN;
        p.relogin = "0";

		// 登录信息
        var loginNode = Cache.XmlIslands.get(CACHE_LOGIN_FORM);
        if( null != loginNode ) {
            var dataNode = loginNode.selectSingleNode(".//data");
			var prefix   = loginNode.selectSingleNode("./declare").getAttribute("prefix");
            if( null != dataNode ) {
                var nodes = dataNode.selectNodes("./row/*");
                for(var i=0 ; i < nodes.length; i++){
                    var name  = nodes[i].nodeName;
                    var value = nodes[i].text;

                    // 从data节点上获取保存名，如果没有则用原名
                    var rename = dataNode.getAttribute(name);
                    if( null != rename ) {
                        name = rename;
                    }

                    if( null != prefix ) {
                        name = prefix + "." + name;
                    }

                    p.setHeader(name, value);
                }
            }
        }

        var request = new HttpRequest(p);
        request.onexception = function(){
            var loginFormObj = $("loginForm");
            loginFormObj.setFocus("password");
        }
        request.onsuccess = function(){
            location.href = "index.html";
        }
        request.send();
    }

    /*
     *	回车自动提交
     */
    function autoLogin() {
        if( 13 == event.keyCode ){
            event.returnValue = false;

            var btLogin = $("btLogin");
            btLogin.focus();

            setTimeout(function() {
                login();
            }, 10);
        }
    }

    /*
     *	找回密码
     */
    function forget() {
        window.open("forget.htm", "", "width=400, height=400");
    }

    /*
     *	注册
     */
    function register() {
        window.open("register.htm", "", "width=600, height=400");
    }

    /*
     *	取消
     */
    function resetForm() {
        var loginFormObj = $("loginForm");
        loginFormObj.resetForm();

        loginFormObj.setFocus();
    }

    window.onload = init;
//-->
</SCRIPT>

</head>

<body>
<table class="full" border="0" cellpadding="0" cellspacing="0">
<tr> 
  <td class="loginContainer">
    <!-- 登录框 开始 -->
	<div class="loginBox">
		<!-- xform 开始 -->
		<Xform:Form id="loginForm" baseurl="core/htc/xform1.2.3/" editable="true" actionbaseurl=""><div class="loading"></div></Xform:Form>
		<!-- xform 结束 -->
    </div>
    <!-- 登录框 结束 -->
  </td>
</tr>
</table>
</body>
</html>
