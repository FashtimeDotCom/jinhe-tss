<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML xmlns:Tree xmlns:XForm xmlns:WorkSpace>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>门户结构管理</title>

<link href="../framework/css/css.css" rel="stylesheet" type="text/css"></link>
<link href="../framework/menu/menu.css" rel="stylesheet" type="text/css"></link>
<link href="../framework/balloon/balloon.css" rel="stylesheet" type="text/css"></link>
<link href="../framework/workspace/workspace.css" rel="stylesheet" type="text/css"></link>
<link href="../framework/tree/tree.css" rel="stylesheet" type="text/css"></link>
<link href="../framework/xform/xform.css" rel="stylesheet" type="text/css"></link>

<script language="javascript" src="../framework/core.js"></script>
<script language="javascript" src="../framework/ajax.js"></script>
<script language="javascript" src="../framework/framework.js"></script>
<script language="javascript" src="../framework/menu/menu.js"></script>
<script language="javascript" src="../framework/balloon/balloon.js"></script>
<script language="javascript" src="../framework/workspace/workspace.js"></script>
<script language="javascript" src="../framework/tree/tree.js"></script>
<script language="javascript" src="../framework/xform/xform.js"></script>

<script language="javascript" src="structure.js"></script>

<SCRIPT LANGUAGE="JavaScript">
<!--
	/*
	 *  对象名称：PortletInstance对象
	 *  职责：负责处理所有PortletInstance操作
	 */
	function PortletInstance(portletId){
		if(null!=portletId){
			this.portletId = portletId;
			this.object = $(portletId);
		}
	}
	/*
	 *	函数说明：加载portlet实例
	 *	参数：	string:id 	    
				object:type     
	 *	返回值：
	 *	作者：毛云
	 *	日期：2006-8-4
	 *
	 */
	PortletInstance.prototype.load = function(id, type){
		var thisObj = this;

		var p = new HttpRequestParams();
		p.url = "group!previewElement.action";
		p.setContent("id", id);
		p.setContent("type", type);
		p.setContent("dataType", "XML");

		var request = new HttpRequest(p);
		request.onresult = function(){
			var portletNode = this.getNodeValue("rss");            
			thisObj.create(portletNode);

			//插入新对象
			var parentNode = document.body;
			parentNode.appendChild(thisObj.object);

			//创建css
			thisObj.createCSS();

			//创建脚本
			thisObj.createScript();

			//触发组件的 onload 事件
			thisObj.fire("onload");
		}
		request.send();
	}
	/*
	 *	函数说明：创建portlet
	 *	参数：	
	 *	返回值：
	 *	作者：毛云
	 *	日期：2006-8-4
	 *
	 */
	PortletInstance.prototype.create = function(portletNode){
		var style = portletNode.selectSingleNode("style"); 
		var html = portletNode.selectSingleNode("html");
		var script = portletNode.selectSingleNode("script");
		var events = portletNode.selectSingleNode("event");

		var container = Element.createElement("div");
		container.innerHTML = html.firstChild.nodeValue;
		var portletInstanceObj = container.getElementsByTagName("*")[0];

		this.script = script;
		this.events = events;
		this.style = style;

		this.object = portletInstanceObj;
		this.portletId = portletInstanceObj.id;
	}
	/*
	 *	函数说明：创建css
	 *	参数：	
	 *	返回值：
	 *	作者：毛云
	 *	日期：2006-8-4
	 *
	 */
	PortletInstance.prototype.createCSS = function(){
		var style = this.style;

		//创建css
		if(null != style && style.firstChild != null){
			if(_BROWSER==_BROWSER_IE){
				var newStyle = document.createStyleSheet();
				newStyle.cssText = style.firstChild.nodeValue;
			}else{
				var newStyle = document.createElement("style");
				newStyle.textContent = style.firstChild.nodeValue;
				var headObj = document.getElementsByTagName("head")[0];
				headObj.appendChild(newStyle);
			}
		}

	}
	/*
	 *	函数说明：创建脚本
	 *	参数：	
	 *	返回值：
	 *	作者：毛云
	 *	日期：2006-8-4
	 *
	 */
	PortletInstance.prototype.createScript = function(){
		var script = this.script;
		var events = this.events;

		//添加脚本
		if(null!=script){
			var declare = script.firstChild.nodeValue;

			//从declare内容创建<script>
			var headObj = document.getElementsByTagName("head")[0];
			var newScriptObj = Element.createElement("script");
			newScriptObj.text = declare;
			headObj.appendChild(newScriptObj);
		}

		//添加事件
		if(null!=events){
			//将绑定事件保存在实例属性中
			var attachs = events.selectNodes("attach");
			this.attachs = {};

			for(var i=0,iLen=attachs.length;i<iLen;i++){
				var attach = attachs[i];
				var eventName = attach.getAttribute("event");
				var onEvent = attach.getAttribute("onevent");

				this.attachs[eventName] = onEvent;
			}        
		}
	}
	/*
	 *	函数说明：触发事件
	 *	参数：	
	 *	返回值：
	 *	作者：毛云
	 *	日期：2006-8-4
	 *
	 */
	PortletInstance.prototype.fire = function(eventName){
		if(null!=this.attachs){
			var onEvent = this.attachs[eventName];
			if(null!=onEvent && null!=window[onEvent]){
				window[onEvent]();
			}        
		}
	}

	window.onload = function() {
		var elementId = Query.get("id");
		var type = Query.get("type");

		var instance = new PortletInstance();
		instance.load(elementId, type);
	}
//-->
</SCRIPT>

</head>

<body>
</body>
</html>
