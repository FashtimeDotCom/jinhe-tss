<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>它山石--用户信息</title>

<link href="css/css.css" rel="stylesheet" type="text/css">
<link href="common/xform/xform.css" rel="stylesheet" type="text/css">
<link href="common/balloon/balloon.css" rel="stylesheet" type="text/css">

<script language="javascript" src="js/core.js"></script>
<script language="javascript" src="js/framework.js"></script>

<script language="javascript" src="common/balloon/balloon.js"></script>

<script language="javascript" src="common/xform/xform.js"></script>
<script language="javascript" src="common/xform/mode.js"></script>


<!-- 当前页相关脚本 开始 -->
<style>
 body {
  text-align:left;
  padding: 4px;
  overflow:auto;
  width:100%;
  height:250px;
}
#userInfo #passwordInfo {
	padding:3px;
	height:20px;
	width:80px;
	top:1px;
	border-top:1px solid #3399ff;
	border-left:1px solid #3399ff;
	border-right:1px solid #3399ff;
	z-index:12;
	text-align:center;
	position:relative;
}
.hidden {
	cursor:pointer;
	cursor:hand;
	background-color:#6FB7FF;
	border-bottom:1px solid #3399ff;
	color:#FFFFFF;
}
.display {
	background-color:#FFFFFF;
	font-weight:bold;
	cursor:pointer;
	cursor:hand;
}
</style>
<!-- 当前页相关脚本 结束 -->

<SCRIPT LANGUAGE="JavaScript">
<!--
	/*
     *	后台响应数据节点名称
     */
    XML_REGISTER_INFO = "UserInfo";
	XML_PASSWORD_INFO = "PasswordInfo";
	XML_SECURITY_LEVEL = "SecurityLevel";
    /*
     *	默认唯一编号名前缀
     */
    CACHE_REGISTER_INFO = "register__id";

    /*
     *	XMLHTTP请求地址汇总
     */
    URL_INIT = "test/mockdata/register_init.xml";
    URL_MODIFY_USER_INFO = "test/mockdata/_success.xml";
    URL_CHECK_PASSWORD = "test/mockdata/password_check.xml";
	URL_CHANGE_PWD = "test/mockdata/_success.xml";


//    URL_INIT = "ums/user!getUserInfo.action";
//    URL_MODIFY_USER_INFO = "ums/user!modifyUserSelf.action";
//    URL_CHECK_PASSWORD = "getStrength.in";
//	  URL_CHANGE_PWD = "resetPassword.in";

	var registerForm;
	var passwordForm;

    /*
     *	函数说明：页面初始化
     */
    function init() {
	    var userInfoTab = $("userInfoTab");
		var passwordTab = $("passwordInfoTab");
		var userInfoDiv = $("userInfo");
		var passwordDiv = $("passwordInfo");

		var saveUIButton  = $("saveUIButton");
		var savePWDButton = $("savePWDButton");

		passwordTab.className = "hidden";
		userInfoTab.className = "display";

		passwordDiv.style.display = "none";
		savePWDButton.style.display = "none";

		userInfoTab.onclick = function() {
			userInfoDiv.style.display = "block";
			passwordDiv.style.display = "none";
			saveUIButton.style.display = "";
			savePWDButton.style.display = "none";
			userInfoTab.className = "display";
			passwordTab.className = "hidden";
		};
		passwordTab.onclick = function() {
			userInfoDiv.style.display = "none";
			passwordDiv.style.display = "block";
			saveUIButton.style.display = "none";
			savePWDButton.style.display = "";
			userInfoTab.className = "hidden";
			passwordTab.className = "display";
		};

        var p = new HttpRequestParams();
        p.url = URL_INIT;
		p.setHeader("appCode", APP_CODE);
        p.setContent("isModifyOrRegister", "modify");

        var request = new HttpRequest(p);
        request.onresult = function() {
            var registerXML = this.getNodeValue(XML_REGISTER_INFO);
            Cache.XmlIslands.add(XML_REGISTER_INFO, registerXML);
			registerForm = $X("registerForm");
			registerForm.load(registerXML.node);

			var passwordXML = this.getNodeValue(XML_PASSWORD_INFO); 
            Cache.XmlIslands.add(XML_PASSWORD_INFO, passwordXML);
			passwordForm = $X("passwordForm");
			passwordForm.load(passwordXML.node);

			$("newPassword").onblur = function() { 
				var password = this.value;
				if(password == null || password == "") return;
				
				var loginName = passwordForm.getData("loginName");
				checkPasswordSecurityLevel(passwordForm, URL_CHECK_PASSWORD, password, loginName);
			}
        }
        request.send();
    }

    /*
     *	函数说明：用户修改用户信息
     */
    function modifyUserInfo() {
        var p = new HttpRequestParams();
        p.url = URL_MODIFY_USER_INFO;
		p.setHeader("appCode", APP_CODE);

        //登录信息
        var userInfoNode = Cache.XmlIslands.get(CACHE_REGISTER_INFO);
        if( null != userInfoNode ) {
            var dataNode = userInfoNode.selectSingleNode(".//data");
            if(dataNode != null) {
                var nodes = dataNode.selectNodes("./row/*");
                for(var i=0; i < nodes.length; i++ ) {
                    var name  = nodes[i].nodeName;
                    var value = nodes[i].text;
                    p.setContent(name, value);
                }
            }
        }

        var request = new HttpRequest(p);
        request.onsuccess = function(){
             alert(121212);
        }
        request.send();
    }

    function changePassword() {
		var oldpassword = passwordForm.getData("password");
        var password    = passwordForm.getData("newPassword");
        var repassword  = passwordForm.getData("newPassword2");

        if(password != repassword) {
            return alert("两次密码输入不一致，请重新确认");
        }
		else if(null == password || "" == password) {
            return alert("原密码不能为空");
        }

		var p = new HttpRequestParams();
		p.url = URL_CHANGE_PWD;
		p.setHeader("appCode",  APP_CODE);
		p.setContent("password", oldpassword);
		p.setContent("newPassword", password);
		p.setContent("userId", passwordForm.getData("userId"));

		var request = new HttpRequest(p);
		request.onsuccess = function() {
			window.close();
		}
		request.send();
    }

    window.onload = init;

//-->
</SCRIPT>
</head>

<body>
<table class="full" border="0" cellpadding="0" cellspacing="0">
<tr> 
  <td class="loginContainer" style="background-position:center -400;padding-top:0px">
      <table>
        <tr>
          <td class="loginBox" style="width:500px;">
		    <div align="left">
				<span style="width:10px"></span> <span id="userInfoTab">基本信息</span>
				<span style="width: 5px"></span> <span id="passwordInfoTab">修改密码</span>
			</div>

			<div class="xformBox" id="userInfo">
				<div id="registerForm" _baseurl="common/xform/"><div class="loading"></div></div>
			</div>

			<div class="xformBox"  id="passwordInfo">
				<div id="passwordForm" _baseurl="common/xform/"><div class="loading"></div></div>
			</div>
			
			<input type="button" class="btStrong" value="保存" onclick="modifyUserInfo()" id="saveUIButton"/>
			<input type="button" class="btStrong" value="修改" onclick="changePassword()" id="savePWDButton"/>
			<input type="button" class="btWeak"   value="关闭" onclick="window.close()"/>
          </td>
        </tr>
      </table>
  </td>
</tr>
</table>
</body>
</html>
